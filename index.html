<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WaterGuard ‚Äî —É–º–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ—Ä–æ—à–µ–Ω–∏—è</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#58c0a7;--muted:#9aa6b2;--glass:rgba(255,255,255,0.03)}
    *{box-sizing:border-box;font-family:Inter, Roboto, system-ui, -apple-system, 'Segoe UI', 'Helvetica Neue', Arial}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#071028 0%, #071a2a 100%);color:#e6eef6;padding:28px}
    .wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 420px;gap:20px}
    header{grid-column:1/-1;display:flex;align-items:center;gap:16px}
    h1{margin:0;font-size:20px}
    .subtitle{color:var(--muted);font-size:13px}

    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 30px rgba(2,6,23,0.6);}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px}
    input[type="number"], select{width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .muted{color:var(--muted);font-size:13px}
    button{background:var(--accent);border:none;padding:10px 14px;border-radius:10px;color:#062022;font-weight:600;cursor:pointer}
    button:hover{opacity:0.9}
    .result{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:10px;margin-top:12px}
    .big{font-size:20px;font-weight:700}
    .tiny{font-size:12px;color:var(--muted)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--glass);color:var(--muted);font-size:12px;cursor:pointer}
    .pill:hover{background:rgba(255,255,255,0.08)}
    .warn{color:#ffb35c}
    .danger{color:#ff7a7a}
    footer{grid-column:1/-1;margin-top:8px;color:var(--muted);font-size:13px}
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .legend .item{display:flex;gap:8px;align-items:center}
    .swatch{width:12px;height:12px;border-radius:3px}

    /* simple visual widgets */
    .viz{display:flex;gap:12px;align-items:center}
    .water-bar{width:14px;height:120px;background:#072;border-radius:6px;position:relative;overflow:hidden}
    .water-fill{position:absolute;left:0;right:0;bottom:0;background:linear-gradient(180deg,#58c0a7,#2ea588)}
    .meter{width:120px;height:120px;display:flex;align-items:center;justify-content:center}
    .thermo{width:28px;height:120px;background:linear-gradient(to top,#3b8, #071);border-radius:8px;position:relative;overflow:hidden}
    .thermo-fill{position:absolute;left:0;right:0;bottom:0;background:linear-gradient(180deg,#ff7a7a,#ffb35c)}
    .history-table{width:100%;border-collapse:collapse;margin-top:10px}
    .history-table th,.history-table td{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px;color:var(--muted)}
    .about{font-size:13px;color:var(--muted);line-height:1.4}
    
    /* New styles */
    .chart-container{background:var(--glass);border-radius:8px;padding:12px;margin-top:12px}
    .chart-container canvas{max-height:200px}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:12px}
    .stat-box{background:var(--glass);border-radius:8px;padding:10px;text-align:center}
    .stat-value{font-size:18px;font-weight:700;color:var(--accent);margin-top:4px}
    .favorites{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .fav-btn{background:rgba(88,192,167,0.2);border:1px solid var(--accent);padding:6px 10px;border-radius:6px;font-size:12px;cursor:pointer;color:var(--accent)}
    .fav-btn:hover{background:rgba(88,192,167,0.3)}
    .fav-btn.active{background:var(--accent);color:#062022}

    /* responsive */
    @media (max-width:940px){.wrap{grid-template-columns:1fr;padding:0 8px} .card{padding:14px} .viz{flex-direction:column;gap:8px} .stats-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="card" style="display:flex;align-items:center;gap:12px;padding:10px 14px">
        <div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#3bb0d6);display:flex;align-items:center;justify-content:center;color:#042e29;font-weight:800">WG</div>
        <div>
          <h1>WaterGuard ‚Äî —É–º–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ—Ä–æ—à–µ–Ω–∏—è</h1>
          <div class="subtitle">–ë—ã—Å—Ç—Ä—ã–π —Ä–∞—Å—á–µ—Ç ‚Äî –≤–≤–æ–¥–∏—à—å –ø–æ–ª–µ, –∫—É–ª—å—Ç—É—Ä—É, –≤–ª–∞–∂–Ω–æ—Å—Ç—å –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É ‚Üí –ø–æ–ª—É—á–∞–µ—à—å –æ–±—ä—ë–º –≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é.</div>
        </div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="showStats" class="pill">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        <button id="showAbout" class="pill">–û –ø—Ä–æ–µ–∫—Ç–µ</button>
        <button id="exportCSV" class="pill">–≠–∫—Å–ø–æ—Ä—Ç</button>
      </div>
    </header>

    <!-- left: form + explanation -->
    <div class="card">
      <form id="wg-form">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
          <label style="flex:1">
            <div style="display:flex;justify-content:space-between;align-items:center"><span>–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è</span><span class="tiny muted">–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞</span></div>
            <input id="fieldName" type="text" placeholder="–Ω–∞–ø—Ä. –ü–æ–ª–µ 1" />
          </label>
          <button type="button" id="addFav" class="pill" style="margin-top:18px">‚òÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>

        <div id="favoritesBox" style="display:none;margin-bottom:12px">
          <div class="tiny muted">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–ª—è:</div>
          <div class="favorites" id="favoritesList"></div>
        </div>

        <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
          <label style="flex:1">
            <div style="display:flex;justify-content:space-between;align-items:center"><span>–ü–ª–æ—â–∞–¥—å –ø–æ–ª—è</span><span class="tiny muted">–≤ –≥–∞ –∏–ª–∏ –º¬≤</span></div>
            <div class="row">
              <input id="area" type="number" min="0" step="0.01" placeholder="–Ω–∞–ø—Ä. 1.5" required />
              <select id="area-unit" style="width:120px">
                <option value="ha">–≥–∞</option>
                <option value="m2">–º¬≤</option>
              </select>
            </div>
          </label>
        </div>

        <div style="display:flex;gap:12px;margin-bottom:12px">
          <label class="col">
            <div style="display:flex;justify-content:space-between;align-items:center"><span>–¢–∏–ø –∫—É–ª—å—Ç—É—Ä—ã</span><span class="tiny muted">–ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∏</span></div>
            <select id="crop" required>
              <option value="wheat">–ü—à–µ–Ω–∏—Ü–∞</option>
              <option value="corn">–ö—É–∫—É—Ä—É–∑–∞</option>
              <option value="potato">–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å</option>
              <option value="vegetables">–û–≤–æ—â–Ω—ã–µ</option>
              <option value="cotton">–•–ª–æ–ø–æ–∫</option>
              <option value="custom">–î—Ä—É–≥–æ–µ (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Ä—É—á–Ω—É—é)</option>
            </select>
          </label>

          <label class="col">
            <div style="display:flex;justify-content:space-between;align-items:center"><span>–¢–µ–∫—É—â–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã</span><span class="tiny muted">% (0‚Äì100)</span></div>
            <input id="soil" type="number" min="0" max="100" step="1" value="60" />
          </label>
        </div>

        <div style="display:flex;gap:12px;margin-bottom:12px">
          <label class="col">
            <div style="display:flex;justify-content:space-between;align-items:center"><span>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–æ–∑–¥—É—Ö–∞</span><span class="tiny muted">¬∞C</span></div>
            <input id="temp" type="number" step="0.1" value="25" />
          </label>

          <label class="col">
            <div style="display:flex;justify-content:space-between;align-items:center"><span>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Ä–æ—à–µ–Ω–∏—è</span><span class="tiny muted">0.5‚Äì1.0</span></div>
            <input id="eff" type="number" min="0.5" max="1" step="0.01" value="0.75" />
          </label>
        </div>

        <div id="custom-settings" style="display:none;margin-bottom:12px;border-radius:8px;padding:10px;background:var(--glass);">
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <label style="flex:1"><div class="tiny muted">Kc (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫—É–ª—å—Ç—É—Ä—ã)</div><input id="kc" type="number" step="0.01" value="0.9" /></label>
            <label style="flex:1"><div class="tiny muted">–ì–ª—É–±–∏–Ω–∞ –∫–æ—Ä–Ω–µ–≤–æ–π –∑–æ–Ω—ã (–º–º)</div><input id="rootDepth" type="number" step="1" value="300" /></label>
          </div>
          <div style="display:flex;gap:8px">
            <label style="flex:1"><div class="tiny muted">–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å (%)</div><input id="smOpt" type="number" step="1" value="70" /></label>
            <label style="flex:1"><div class="tiny muted">–¢–æ—á–∫–∞ —É–≤—è–¥–∞–Ω–∏—è (%)</div><input id="smWilt" type="number" step="1" value="25" /></label>
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <button type="button" id="calc">–ü–æ—Å—á–∏—Ç–∞—Ç—å</button>
          <button type="button" id="save" class="pill">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ—Ä–µ–Ω–∏–µ</button>
          <div class="pill">–ë—ã—Å—Ç—Ä–∞—è —Ñ–æ—Ä–º—É–ª–∞: ET‚ÇÄ ‚âà 0.3 √ó T (–º–º/–¥–µ–Ω—å)</div>
        </div>

        <div class="result" id="result" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="muted">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á—ë—Ç–∞</div>
              <div id="summary" class="big" style="margin-top:6px"></div>
              <div id="subsummary" class="tiny muted" style="margin-top:6px"></div>
            </div>
            <div style="text-align:right">
              <div class="tiny muted">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –ø–æ–¥–∞—á–∞</div>
              <div id="appliedLiters" class="big" style="margin-top:6px"></div>
            </div>
          </div>

          <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="tiny muted">–î–µ—Ç–∞–ª–∏</div>
              <ul id="details" style="margin:8px 0 0 16px;color:var(--muted)"></ul>
            </div>
            <div>
              <div class="tiny muted">–°—Ç–∞—Ç—É—Å</div>
              <div id="status" style="margin-top:8px"></div>
              <div id="todRec" style="margin-top:8px" class="tiny muted"></div>
              <div class="legend" id="legend" style="margin-top:8px">
                <div class="item"><div class="swatch" style="background:#58c0a7"></div><div class="tiny muted">–Ω–æ—Ä–º–∞–ª—å–Ω–æ</div></div>
                <div class="item"><div class="swatch" style="background:#ffb35c"></div><div class="tiny muted">—Å–ª–µ–¥–∏—Ç—å</div></div>
                <div class="item"><div class="swatch" style="background:#ff7a7a"></div><div class="tiny muted">—Å—Ä–æ—á–Ω–æ –ø–æ–ª–∏–≤–∞—Ç—å / –∏–∑–±—ã—Ç–æ–∫</div></div>
              </div>
            </div>
          </div>

          <!-- visualizations -->
          <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;gap:12px">
            <div class="viz">
              <div style="text-align:center;margin-right:6px"><div class="tiny muted">–í–ª–∞–∂–Ω–æ—Å—Ç—å</div><div class="meter" id="humidityMeter"></div></div>
              <div style="text-align:center;margin-right:6px"><div class="tiny muted">–£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã</div><div class="water-bar"><div id="waterFill" class="water-fill" style="height:60%"></div></div></div>
              <div style="text-align:center"><div class="tiny muted">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div><div class="thermo"><div id="thermoFill" class="thermo-fill" style="height:40%"></div></div></div>
            </div>
            <div style="width:260px;text-align:left">
              <div class="tiny muted">–ë—ã—Å—Ç—Ä—ã–µ –Ω–æ—Ä–º—ã –ø–æ –∫—É–ª—å—Ç—É—Ä–µ</div>
              <div id="cropCard" style="margin-top:8px;color:var(--muted);font-size:13px"></div>
            </div>
          </div>

          <!-- Chart Trend -->
          <div class="chart-container">
            <div class="tiny muted">–ì—Ä–∞—Ñ–∏–∫ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è)</div>
            <canvas id="trendChart"></canvas>
          </div>

          <!-- history -->
          <div style="margin-top:12px">
            <div class="tiny muted">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ—Ä–µ–Ω–∏–π (–ª–æ–∫–∞–ª—å–Ω–æ)</div>
            <table class="history-table" id="historyTable">
              <thead><tr><th>–î–∞—Ç–∞</th><th>–ö—É–ª—å—Ç—É—Ä–∞</th><th>–í–ª.</th><th>–¢¬∞C</th><th>–û–±—ä—ë–º</th></tr></thead>
              <tbody></tbody>
            </table>
            <div style="margin-top:8px"><button id="clearHistory" class="pill">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button></div>
          </div>

        </div>

      </form>

      <div style="margin-top:12px;color:var(--muted);font-size:13px">
        <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ.</strong> –≠—Ç–æ –ø—Ä–æ—Ç–æ—Ç–∏–ø —Å —É–ø—Ä–æ—â—ë–Ω–Ω—ã–º–∏ —Ñ–æ—Ä–º—É–ª–∞–º–∏. –ó–Ω–∞—á–µ–Ω–∏—è Kc, –≥–ª—É–±–∏–Ω—ã –∫–æ—Ä–Ω–µ–π –∏ –ø–æ—Ä–æ–≥–∏ ‚Äî –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–µ. –ü–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –≤ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã—Ö –º–∞—Å—à—Ç–∞–±–∞—Ö ‚Äî –∫–∞–ª–∏–±—Ä—É–π—Ç–µ –ø–æ–¥ –º–µ—Å—Ç–Ω—ã–µ —É—Å–ª–æ–≤–∏—è.
      </div>
    </div>

    <!-- right: presets + help + stats -->
    <aside class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="muted">–ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫—É–ª—å—Ç—É—Ä</div>
        <div class="tiny muted">–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏</div>
      </div>
      <div style="margin-top:12px;display:grid;gap:8px">
        <div style="display:flex;justify-content:space-between"><div>–ü—à–µ–Ω–∏—Ü–∞</div><div class="tiny muted">Kc 0.80 ¬∑ –∫–æ—Ä–Ω–∏ 400 –º–º</div></div>
        <div style="display:flex;justify-content:space-between"><div>–ö—É–∫—É—Ä—É–∑–∞</div><div class="tiny muted">Kc 1.10 ¬∑ –∫–æ—Ä–Ω–∏ 500 –º–º</div></div>
        <div style="display:flex;justify-content:space-between"><div>–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å</div><div class="tiny muted">Kc 0.95 ¬∑ –∫–æ—Ä–Ω–∏ 300 –º–º</div></div>
        <div style="display:flex;justify-content:space-between"><div>–û–≤–æ—â–Ω—ã–µ</div><div class="tiny muted">Kc 0.90 ¬∑ –∫–æ—Ä–Ω–∏ 300 –º–º</div></div>
        <div style="display:flex;justify-content:space-between"><div>–•–ª–æ–ø–æ–∫</div><div class="tiny muted">Kc 1.00 ¬∑ –∫–æ—Ä–Ω–∏ 600 –º–º</div></div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)" />

      <div class="muted">–ö–∞–∫ —Å—á–∏—Ç–∞–µ–º (–∫–æ—Ä–æ—Ç–∫–æ)</div>
      <ol style="color:var(--muted);font-size:13px;margin-top:8px;padding-left:18px">
        <li>–û—Ü–µ–Ω–∏–≤–∞–µ–º ET‚ÇÄ ‚âà 0.3 √ó T (–º–º/–¥–µ–Ω—å) ‚Äî —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –∏—Å–ø–∞—Ä–µ–Ω–∏—è –≤–æ–∑–¥—É—Ö–∞.</li>
        <li>ETc = Kc √ó ET‚ÇÄ ‚Äî –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –∫—É–ª—å—Ç—É—Ä—ã –≤ –≤–æ–¥–µ (–º–º/–¥–µ–Ω—å).</li>
        <li>–°—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –≤–æ–¥—ã –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –ø–æ–¥–Ω—è—Ç—å –≤–ª–∞–∂–Ω–æ—Å—Ç—å –¥–æ –æ–ø—Ç–∏–º—É–º–∞ (–º–º ‚Üí –ª–∏—Ç—Ä—ã).</li>
        <li>–£—á–∏—Ç—ã–≤–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Ä–æ—à–µ–Ω–∏—è: —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–∞—á–∞ = —Ç—Ä–µ–±—É–µ–º–æ–µ / eff.</li>
      </ol>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)" />

      <div id="statsBox" style="display:none">
        <strong>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="tiny muted">–í—Å–µ–≥–æ –ø–æ–ª–∏–≤–æ–≤</div>
            <div class="stat-value" id="statCount">0</div>
          </div>
          <div class="stat-box">
            <div class="tiny muted">–í–æ–¥—ã –ø–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
            <div class="stat-value" id="statTotal">0</div>
          </div>
          <div class="stat-box">
            <div class="tiny muted">–°—Ä–µ–¥–Ω–µ–µ</div>
            <div class="stat-value" id="statAvg">0</div>
          </div>
        </div>
      </div>

      <div class="about" id="aboutBox" style="display:none;margin-top:8px">
        <strong>–û –ø—Ä–æ–µ–∫—Ç–µ WaterGuard</strong>
        <p>WaterGuard ‚Äî –ª—ë–≥–∫–∏–π –≤–µ–±-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —Ä–µ—à–µ–Ω–∏–π –ø–æ –ø–æ–ª–∏–≤—É. –û–Ω —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–∞ –º–∞–ª—ã—Ö –∏ —Å—Ä–µ–¥–Ω–∏—Ö —Ñ–µ—Ä–º–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∏–º–µ—é—Ç –¥–∞—Ç—á–∏–∫–æ–≤, –Ω–æ —Ö–æ—Ç—è—Ç —Ä–∞–∑—É–º–Ω–æ —Ä–∞—Å—Ö–æ–¥–æ–≤–∞—Ç—å –≤–æ–¥—É.</p>
        <p>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: –≤–≤–æ–¥–∏—Ç–µ –ø–ª–æ—â–∞–¥—å, —Ç–µ–∫—É—â—É—é –≤–ª–∞–∂–Ω–æ—Å—Ç—å –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É ‚Äî —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –æ–±—ä—ë–º –≤–æ–¥—ã –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ–ª–∏–≤–∞. –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</p>
        <p>–≠—Ç–æ –ø—Ä–æ—Ç–æ—Ç–∏–ø. –î–ª—è –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∏ —Ç–µ—Å—Ç—ã –≤ –ø–æ–ª–µ–≤—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö.</p>
      </div>

    </aside>

    <footer>–°–º–µ–ª–µ–µ –∂–º–∏ ¬´–ü–æ—Å—á–∏—Ç–∞—Ç—å¬ª. –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–ª—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</footer>
  </div>

  <script>
    const presets = {
      wheat:{kc:0.8, root:400, smOpt:65, smWilt:25, ad:0.5, desc:'–ü—à–µ–Ω–∏—Ü–∞ ‚Äî —É–º–µ—Ä–µ–Ω–Ω–∞—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤–æ–¥—ã.'},
      corn:{kc:1.1, root:500, smOpt:70, smWilt:30, ad:0.5, desc:'–ö—É–∫—É—Ä—É–∑–∞ ‚Äî –≤—ã—Å–æ–∫–∞—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ —Ñ–∞–∑—É –≤–µ–≥–µ—Ç–∞—Ü–∏–∏.'},
      potato:{kc:0.95, root:300, smOpt:70, smWilt:25, ad:0.5, desc:'–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å ‚Äî —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ –Ω–µ—Ä–µ–≥—É–ª—è—Ä–Ω–æ–º—É –ø–æ–ª–∏–≤—É.'},
      vegetables:{kc:0.9, root:300, smOpt:75, smWilt:30, ad:0.45, desc:'–û–≤–æ—â–Ω—ã–µ ‚Äî —á–∞—Å—Ç—ã–µ, –Ω–æ –Ω–µ–±–æ–ª—å—à–∏–µ –ø–æ–ª–∏–≤—ã –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ.'},
      cotton:{kc:1.0, root:600, smOpt:65, smWilt:25, ad:0.5, desc:'–•–ª–æ–ø–æ–∫ ‚Äî –≥–ª—É–±–æ–∫–∞—è –∫–æ—Ä–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞, –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª–∏–≤—ã.'}
    }

    const cropNames = {
      wheat: '–ü—à–µ–Ω–∏—Ü–∞',
      corn: '–ö—É–∫—É—Ä—É–∑–∞',
      potato: '–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å',
      vegetables: '–û–≤–æ—â–Ω—ã–µ',
      cotton: '–•–ª–æ–ø–æ–∫',
      custom: '–î—Ä—É–≥–æ–µ'
    }

    const $ = id=>document.getElementById(id)
    const cropEl = $('crop')
    const customBox = $('custom-settings')
    let trendChart = null

    cropEl.addEventListener('change',e=>{
      if(e.target.value==='custom') customBox.style.display='block'
      else customBox.style.display='none'
      applyPreset()
    })

    function applyPreset(){
      const val = cropEl.value
      if(presets[val]){
        const p = presets[val]
        $('kc').value = p.kc
        $('rootDepth').value = p.root
        $('smOpt').value = p.smOpt
        $('smWilt').value = p.smWilt
        $('cropCard').innerText = p.desc + ' (Kc=' + p.kc + ', –∫–æ—Ä–Ω–∏ ' + p.root + ' –º–º)'
      } else $('cropCard').innerText = '–ù–∞—Å—Ç—Ä–æ–π –≤—Ä—É—á–Ω—É—é –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫—É–ª—å—Ç—É—Ä—ã.'
    }
    applyPreset()

    function mmToLitersPerUnit(mm, area, unit){
      let areaM2 = unit==='ha'? area*10000 : area
      return mm * areaM2
    }

    function fmt(n){
      if(isNaN(n)) return '-'
      if(Math.abs(n)>=1000000) return (n/1000000).toFixed(2)+' M'
      if(Math.abs(n)>=1000) return (n/1000).toFixed(2)+' k'
      return n.toFixed(0)
    }

    function updateVisuals(soil, temp, applied_mm){
      const m = $('humidityMeter')
      m.innerHTML = ''
      const size = 100
      const svgns = 'http://www.w3.org/2000/svg'
      const svg = document.createElementNS(svgns,'svg')
      svg.setAttribute('width',size)
      svg.setAttribute('height',size)
      const circleBg = document.createElementNS(svgns,'circle')
      circleBg.setAttribute('cx',size/2); circleBg.setAttribute('cy',size/2); circleBg.setAttribute('r',40)
      circleBg.setAttribute('fill','none'); circleBg.setAttribute('stroke','rgba(255,255,255,0.06)'); circleBg.setAttribute('stroke-width','10')
      svg.appendChild(circleBg)
      const circle = document.createElementNS(svgns,'circle')
      circle.setAttribute('cx',size/2); circle.setAttribute('cy',size/2); circle.setAttribute('r',40)
      circle.setAttribute('fill','none'); circle.setAttribute('stroke','#58c0a7'); circle.setAttribute('stroke-width','10')
      circle.setAttribute('stroke-dasharray', Math.PI*2*40)
      const pct = Math.max(0,Math.min(100,soil))/100
      const dash = (Math.PI*2*40) * pct
      circle.setAttribute('stroke-dashoffset', Math.PI*2*40 - dash)
      circle.setAttribute('transform','rotate(-90 '+(size/2)+' '+(size/2)+')')
      svg.appendChild(circle)
      const txt = document.createElementNS(svgns,'text')
      txt.setAttribute('x',size/2); txt.setAttribute('y',size/2+6); txt.setAttribute('text-anchor','middle')
      txt.setAttribute('font-size','16'); txt.setAttribute('fill','#e6eef6')
      txt.textContent = soil.toFixed(0) + '%'
      svg.appendChild(txt)
      m.appendChild(svg)

      const wf = $('waterFill')
      const level = Math.min(100, Math.max(0, soil))
      wf.style.height = level + '%'

      const tf = $('thermoFill')
      const tmin = -10, tmax = 45
      const th = Math.max(0, Math.min(100, (temp - tmin)/(tmax-tmin)*100))
      tf.style.height = th + '%'
    }

    function drawTrendChart(){
      const key = 'wg_history_v1'
      const raw = localStorage.getItem(key)
      const arr = raw? JSON.parse(raw):[]
      const last10 = arr.slice(0, 10).reverse()
      
      if(last10.length===0) return

      const ctx = $('trendChart').getContext('2d')
      
      if(trendChart) trendChart.destroy()
      
      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: last10.map(it => {
            try { return new Date(it.date).toLocaleString(); }
            catch(e){ return it.date || '' }
          }),
          datasets: [{
            label: '–í–ª–∞–∂–Ω–æ—Å—Ç—å (%)',
            data: last10.map(it=>it.soil),
            borderColor: '#58c0a7',
            backgroundColor: 'rgba(88,192,167,0.1)',
            tension: 0.3,
            fill: true,
            pointRadius: 4,
            pointBackgroundColor: '#58c0a7'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {legend: {display: false}},
          scales: {
            y: {
              min: 0, max: 100,
              ticks: {color: '#9aa6b2'},
              grid: {color: 'rgba(255,255,255,0.03)'}
            },
            x: {
              ticks: {color: '#9aa6b2'},
              grid: {display: false}
            }
          }
        }
      })
    }

    function saveMeasurement(obj){
      const key = 'wg_history_v1'
      const raw = localStorage.getItem(key)
      const arr = raw? JSON.parse(raw):[]
      arr.unshift(obj)
      if(arr.length>50) arr.pop()
      localStorage.setItem(key, JSON.stringify(arr))
      renderHistory()
      drawTrendChart()
    }

    function renderHistory(){
      const key = 'wg_history_v1'
      const raw = localStorage.getItem(key)
      const arr = raw? JSON.parse(raw):[]
      const tbody = $('historyTable').querySelector('tbody')
      tbody.innerHTML = ''
      arr.forEach(it=>{
        const tr = document.createElement('tr')
        tr.innerHTML = '<td>'+it.date+'</td><td>'+it.crop+'</td><td>'+it.soil+'%</td><td>'+it.temp+'¬∞C</td><td>'+it.liters+'</td>'
        tbody.appendChild(tr)
      })
    }

    function updateStats(){
      const key = 'wg_history_v1'
      const raw = localStorage.getItem(key)
      const arr = raw? JSON.parse(raw):[]
      
      let total = 0
      arr.forEach(it=>{
        const liters = parseInt(it.liters.replace(/[^0-9]/g,'')) || 0
        total += liters
      })
      
      $('statCount').innerText = arr.length
      $('statTotal').innerText = fmt(total) + ' –ª'
      $('statAvg').innerText = arr.length>0? fmt(total/arr.length) + ' –ª' : '0 –ª'
    }

    function exportCSV(){
      const key = 'wg_history_v1'
      const raw = localStorage.getItem(key)
      const arr = raw? JSON.parse(raw):[]
      if(arr.length===0){ alert('–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞'); return }
      const headers = ['date','crop','soil','temp','liters']
      const lines = [headers.join(',')]
      arr.forEach(r=>{ lines.push([r.date,r.crop,r.soil,r.temp,r.liters].join(',')) })
      const blob = new Blob([lines.join('\n')],{type:'text/csv'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a'); a.href=url; a.download='waterguard_history.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)
    }

    function saveFavorite(){
      const name = $('fieldName').value.trim()
      const area = $('area').value
      const unit = $('area-unit').value
      const crop = $('crop').value
      
      if(!name){alert('–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è');return}
      if(!area){alert('–£–∫–∞–∂–∏ –ø–ª–æ—â–∞–¥—å');return}
      
      const key = 'wg_favorites'
      const raw = localStorage.getItem(key)
      const arr = raw? JSON.parse(raw):[]
      arr.push({name, area, unit, crop, id: Date.now()})
      localStorage.setItem(key, JSON.stringify(arr))
      renderFavorites()
      alert('–ü–æ–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!')
    }

    function renderFavorites(){
      const key = 'wg_favorites'
      const raw = localStorage.getItem(key)
      const arr = raw? JSON.parse(raw):[]
      
      const list = $('favoritesList')
      list.innerHTML = ''
      
      if(arr.length===0){
        $('favoritesBox').style.display = 'none'
        return
      }
      
      $('favoritesBox').style.display = 'block'
      arr.forEach(fav=>{
        const btn = document.createElement('button')
        btn.className = 'fav-btn'
        btn.type = 'button'
        btn.innerHTML = fav.name + ' (' + fav.area + fav.unit + ')'
        btn.onclick = ()=>loadFavorite(fav)
        list.appendChild(btn)
      })
    }

    function loadFavorite(fav){
      $('fieldName').value = fav.name
      $('area').value = fav.area
      $('area-unit').value = fav.unit
      $('crop').value = fav.crop
      if($('crop').value==='custom') $('custom-settings').style.display='block'
      else $('custom-settings').style.display='none'
      applyPreset()
    }

    $('calc').addEventListener('click',()=>{
      const area = parseFloat($('area').value)
      const unit = $('area-unit').value
      if(isNaN(area) || area<=0){alert('–£–∫–∞–∂–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –ø–ª–æ—â–∞–¥—å');return}
      const crop = $('crop').value
      const soil = parseFloat($('soil').value)
      const temp = parseFloat($('temp').value)
      const eff = parseFloat($('eff').value)
      if(isNaN(soil) || soil<0 || soil>100){alert('–í–ª–∞–∂–Ω–æ—Å—Ç—å 0‚Äì100%');return}
      if(isNaN(temp)){alert('–£–∫–∞–∂–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É');return}
      if(isNaN(eff) || eff<=0 || eff>1.5){alert('–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å 0.5‚Äì1');return}

      let kc = parseFloat($('kc').value)
      let rootDepth = parseFloat($('rootDepth').value)
      let smOpt = parseFloat($('smOpt').value)
      let smWilt = parseFloat($('smWilt').value)
      let ad = 0.5
      if(presets[crop]){ const p = presets[crop]; kc = p.kc; rootDepth = p.root; smOpt=p.smOpt; smWilt=p.smWilt; ad=p.ad }

      const ET0 = 0.3 * temp
      const ETc = kc * ET0
      const smCritical = smOpt - ad * (smOpt - smWilt)
      const dailyLossPercent = (ETc / rootDepth) * 100

      let daysToCritical = Infinity
      if(dailyLossPercent>0){ daysToCritical = (soil - smCritical)/dailyLossPercent }

      const waterToOpt_mm = Math.max(0, (smOpt - soil)/100 * rootDepth)
      const applied_mm = eff>0? waterToOpt_mm / eff : waterToOpt_mm
      const liters = mmToLitersPerUnit(applied_mm, area, unit)

      let statusText = ''
      if(soil <= smCritical){ statusText = '<span class="danger">–í–ª–∞–≥–∞ —É–ø–∞–ª–∞ –Ω–∏–∂–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π ‚Äî –ø–æ–ª–∏–≤ —Å–µ–π—á–∞—Å.</span>' }
      else if(daysToCritical!==Infinity && daysToCritical<=1){ statusText = '<span class="warn">–ü–æ–ª–∏–≤ –≤ –±–ª–∏–∂–∞–π—à–∏–µ 24 —á–∞—Å–∞.</span>' }
      else if(daysToCritical!==Infinity && daysToCritical<=4){ statusText = '<span class="pill">–ß–µ—Ä–µ–∑ ' + Math.max(0,Math.floor(daysToCritical)) + ' –¥–Ω.</span>' }
      else { statusText = '<span class="tiny muted">–í–ª–∞–∂–Ω–æ—Å—Ç—å –≤ –Ω–æ—Ä–º–µ ‚Äî –º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å –ø–æ–ª–∏–≤.</span>' }

      let overWarn = ''
      if(applied_mm>100) overWarn = '<div class="danger">–°–∏–ª—å–Ω—ã–π –æ–±—ä—ë–º –≤–æ–¥—ã (>100 –º–º). –ü—Ä–æ–≤–µ—Ä—å —Ä–∞—Å—á—ë—Ç –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Ä–æ—à–µ–Ω–∏—è.</div>'
      else if(applied_mm>50) overWarn = '<div class="warn">–ë–æ–ª—å—à–æ–π –æ–±—ä—ë–º (>50 –º–º) ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, —á–∞—Å—Ç—å –º–æ–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª–∏–≤–æ–≤.</div>'

      const details = []
      details.push('ET‚ÇÄ (–æ—Ü–µ–Ω–∫–∞): ' + ET0.toFixed(2) + ' –º–º/–¥–µ–Ω—å')
      details.push('ETc (–ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –∫—É–ª—å—Ç—É—Ä—ã): ' + ETc.toFixed(2) + ' –º–º/–¥–µ–Ω—å (Kc=' + kc + ')')
      details.push('–ì–ª—É–±–∏–Ω–∞ –∫–æ—Ä–Ω–µ–π: ' + rootDepth + ' –º–º')
      details.push('–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å: ' + smOpt + '%; –¢–æ—á–∫–∞ —É–≤—è–¥–∞–Ω–∏—è: ' + smWilt + '%')
      details.push('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å (–ø—Ä–∏ AD=' + (ad*100).toFixed(0) + '%): ' + smCritical.toFixed(1) + '%')
      details.push('–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø–æ—Ç–µ—Ä—è –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ (–æ—Ü–µ–Ω–∫–∞): ' + dailyLossPercent.toFixed(2) + ' %/–¥–µ–Ω—å')

      $('result').style.display='block'
      $('summary').innerHTML = applied_mm>0? applied_mm.toFixed(1) + ' –º–º –ø–æ–ª–∏–≤–∞' : '–ü–æ–ª–∏–≤ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è'
      $('subsummary').innerText = '–ù—É–∂–Ω—ã–π –æ–±—ä—ë–º ‚Äî —ç—Ç–æ –ø–æ–¥—ä—ë–º –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ –¥–æ –æ–ø—Ç–∏–º—É–º–∞ (–±–µ–∑ —É—á—ë—Ç–∞ –æ—Å–∞–¥–∫–æ–≤).'
      $('appliedLiters').innerHTML = applied_mm>0? fmt(liters) + ' –ª' : '0 –ª'

      const detailsEl = $('details'); detailsEl.innerHTML = ''
      details.forEach(d=>{ const li=document.createElement('li'); li.innerHTML = d; detailsEl.appendChild(li) })

      $('status').innerHTML = statusText + '<div style="margin-top:8px">' + (daysToCritical===Infinity? '–†–∞—Å—á—ë—Ç –¥–Ω–µ–π –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω' : (daysToCritical<0? '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äî –ø–æ–ª–∏—Ç—å —Å–µ–π—á–∞—Å' : '–û–∂–∏–¥–∞–µ—Ç—Å—è ‚âà ' + (isFinite(daysToCritical)? (daysToCritical>365? '–º–Ω–æ–≥–æ –¥–Ω–µ–π' : daysToCritical.toFixed(1)+' –¥–Ω.') : '-') )) + '</div>' + overWarn

      const tod = getTimeOfDayRec(temp)
      $('todRec').innerHTML = '<strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫:</strong> ' + tod

      updateVisuals(soil, temp, applied_mm)
      drawTrendChart()

      window.lastResult = {date:new Date().toLocaleString(), crop: cropNames[crop] || '–î—Ä—É–≥–æ–µ', soil: soil, temp: temp, liters: fmt(liters)}
    })

    $('save').addEventListener('click',()=>{
      if(!window.lastResult){ alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—á–∏—Ç–∞–π.'); return }
      saveMeasurement(window.lastResult)
      alert('–ò–∑–º–µ—Ä–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ')
    })

    $('addFav').addEventListener('click',saveFavorite)

    $('clearHistory').addEventListener('click',()=>{
      if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?')){ localStorage.removeItem('wg_history_v1'); renderHistory(); updateStats() }
    })

    $('exportCSV').addEventListener('click', exportCSV)

    $('showStats').addEventListener('click',()=>{
      const b = $('statsBox')
      b.style.display = b.style.display==='none'? 'block':'none'
      if(b.style.display==='block') updateStats()
    })

    $('showAbout').addEventListener('click',()=>{
      const b = $('aboutBox')
      b.style.display = b.style.display==='none'? 'block':'none'
    })

    function getTimeOfDayRec(temp){
      const hour = new Date().getHours()
      let part = '—É—Ç—Ä–æ'
      if(hour>=18 || hour<6) part = '–≤–µ—á–µ—Ä–æ–º/–Ω–æ—á—å—é'
      else if(hour>=6 && hour<10) part = '—Ä–∞–Ω–Ω–∏–º —É—Ç—Ä–æ–º'
      else if(hour>=10 && hour<16) part = '–¥–Ω—ë–º'
      else part = '–≤–µ—á–µ—Ä–æ–º'

      let tip = ''
      if(temp>30) tip = '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤—ã—Å–æ–∫–∞—è ‚Üí –ª—É—á—à–µ –ø–æ–ª–∏–≤–∞—Ç—å —É—Ç—Ä–æ–º –∏–ª–∏ –≤–µ—á–µ—Ä–æ–º, —á—Ç–æ–±—ã —Å–Ω–∏–∑–∏—Ç—å –∏—Å–ø–∞—Ä–µ–Ω–∏–µ.'
      else if(temp<5) tip = '–ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ‚Üí –∏–∑–±–µ–≥–∞–π—Ç–µ –Ω–æ—á–Ω—ã—Ö –ø–æ–ª–∏–≤–æ–≤, —Ä–∏—Å–∫ –ø–µ—Ä–µ—É–≤–ª–∞–∂–Ω–µ–Ω–∏—è.'
      else tip = '–û–ø—Ç–∏–º–∞–ª—å–Ω–æ ‚Äî –ø–æ–ª–∏–≤ —É—Ç—Ä–æ–º –∏–ª–∏ –≤–µ—á–µ—Ä–æ–º.'

      return '–°–µ–π—á–∞—Å –ø—Ä–∏–º–µ—Ä–Ω–æ '+part + '. ' + tip
    }

    renderHistory()
    renderFavorites()

  </script>
</body>
</html>